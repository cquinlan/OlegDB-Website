<!DOCTYPE html><html><head><title>OlegDB - Documentation</title><meta charset="UTF-8"><meta name=viewport content="width=device-width, initial-scale=1"><link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'><link rel="stylesheet" media="all" href="/static/css/simplegrid.css" /><link rel="stylesheet" media="all" href="/static/css/main.css" /><link rel="stylesheet" href="/static/css/documentation.css" /><link rel="stylesheet" media="(max-width: 800px)" href="/static/css/mobile.css" /></head><body><header><div class="grid grid-pad"><div id="logo_col" class="col-1-12"><div class="content"><img src="/static/img/oleg_logo.svg"></img></div></div><div class="col-5-12"><div class="content"><h1><a href="/">OlegDB</a></h1></div></div><div class="col-5-12"><div class="pull-right content"><ul><li><a href="/downloads.html">Downloads</a></li><li><a href="/faq.html">FAQ</a></li><li><a href="/documentation.html">Docs</a></li><li><a id="git_icon" href="https://github.com/infoforcefeed/Project-Oleg"><img src="/static/img/git.svg"></img></a></li></ul></div></div></header><div id="main_container"><div class="grid grid-pad"><div class="col-1-1"><div class="content"><h1>Overview</h1><ul><li><a href="#overview">General Overview</a><ul><a href="#getting_started">Getting Started</a></ul></li><li><a href="#macros">Macros</a><ul><li><a href="#VERSION">VERSION</a></li><li><a href="#KEY_SIZE">KEY_SIZE</a></li><li><a href="#HASH_MALLOC">HASH_MALLOC</a></li><li><a href="#PATH_LENGTH">PATH_LENGTH</a></li><li><a href="#DB_NAME_SIZE">DB_NAME_SIZE</a></li><li><a href="#DEVILS_SEED">DEVILS_SEED</a></li></ul></li><li><a href="#enums">Enums</a><ul><li><a href="#ol_feature_flags">ol_feature_flags</a></li></ul></li><li><a href="#structures">Structures</a><ul><li><a href="#ol_bucket">ol_bucket</a></li><li><a href="#ol_database">ol_database</a></li><li><a href="#ol_meta">ol_meta</a></li></ul></li><li><a href="#functions">Functions</a><ul><li><a href="#ol_open">ol_open</a></li><li><a href="#ol_close">ol_close</a></li><li><a href="#ol_close_save">ol_close_save</a></li><li><a href="#ol_unjar">ol_unjar</a></li><li><a href="#ol_unjar_ks">ol_unjar_ks</a></li><li><a href="#ol_jar">ol_jar</a></li><li><a href="#ol_jar_ct">ol_jar_ct</a></li><li><a href="#ol_content_type">ol_content_type</a></li><li><a href="#ol_scoop">ol_scoop</a></li><li><a href="#ol_uptime">ol_uptime</a></li><li><a href="#ol_ht_bucket_max">ol_ht_bucket_max</a></li></ul></li></ul><div class="doc_chunk"><h2 id="overview">General Overview</h2><p>OlegDB is a concurrent, pretty fast K/V hash-table with an Erlang frontend. It uses the <a href=\"https://en.wikipedia.org/wiki/MurmurHash\">Murmur3</a> hashing algorithm to hash and index keys. We chose Erlang for the server because it's functional, uses the actor model and the pattern matching is ridiculous.</p><h3 id="getting_started">Getting Started</h3><p>Running OlegDB using the builtin Erlang interfaces allows you to manipulate data using your standard REST interface commands, GET, POST, DELETE, etc.</p><p>For example, to store the value <span>Raphael</span> into the named database <span>turtles</span> under the key <span>red</span> you could use something like the following:</p><pre><code>$ curl -X POST -d 'Raphael' http://localhost:8080/turtles/test</code></pre><p>Retrieving data is just as simple:</p><pre><code>$ curl http://localhost:8080/turtles/test</code></pre><p>Deleting keys can be done by using DELETE:</p><pre><code>$ curl -X DELETE http://localhost:8080/turtles/test</code></pre></div><div class="doc_chunk"><h2 id="macros">Macros</h2><h3 id="VERSION">VERSION</h3><pre><code>#define VERSION "0.1.0"
</code></pre><p>The current version of the OlegDB.</p><h3 id="KEY_SIZE">KEY_SIZE</h3><pre><code>#define KEY_SIZE 32
</code></pre><p>The hardcoded upperbound for key lengths.</p><h3 id="HASH_MALLOC">HASH_MALLOC</h3><pre><code>#define HASH_MALLOC 65536
</code></pre><p>The size, in bytes, to allocate when initially creating the database. ol_bucket pointers are stored here.</p><h3 id="PATH_LENGTH">PATH_LENGTH</h3><pre><code>#define PATH_LENGTH 256
</code></pre><p>The maximum length of a database's path.</p><h3 id="DB_NAME_SIZE">DB_NAME_SIZE</h3><pre><code>#define DB_NAME_SIZE 64
</code></pre><p>Database maximum name length.</p><h3 id="DEVILS_SEED">DEVILS_SEED</h3><pre><code>#define DEVILS_SEED 666
</code></pre><p>The seed to feed into the murmur3 algorithm.</p></div><div class="doc_chunk"><h2 id="enums">Enums</h2><h3 id="ol_feature_flags">ol_feature_flags</h3><pre><code>typedef enum {
    OL_F_APPENDONLY     = 1 << 0,
    OL_F_SEMIVOL        = 1 << 1,
    OL_F_REGDUMPS       = 1 << 2
} ol_feature_flags;
</code></pre><p>Feature flags tell the database what it should be doing.</p><p><span class="bold">OL_F_APPENDONLY:</span> Enable the append only log</p><p><span class="bold">OL_F_SEMIVOL:</span> Tell servers that it's okay to fsync every once in a while</p><p><span class="bold">OL_F_REGDUMPS:</span> Tell servers to snapshot the data using ol_save() regularly</p></div><div class="doc_chunk"><h2 id="structures">Structures</h2><h3 id="ol_bucket">ol_bucket</h3><pre><code>typedef struct ol_bucket {
    char              key[KEY_SIZE]; /* The key used to reference the data */
    size_t            klen;
    char              *content_type;
    size_t            ctype_size;
    ol_val            data_ptr;
    size_t            data_size;
    uint32_t          hash;
    struct ol_bucket  *next; /* The next ol_bucket in this chain, if any */
} ol_bucket;
</code></pre><p>This is the object stored in the database's hashtable. Contains references to value, key, etc.</p><h3 id="ol_database">ol_database</h3><pre><code>typedef struct ol_database {
    void      (*get_db_file_name)(struct ol_database *db,const char *p,char*);
    void      (*enable)(int, int*);
    void      (*disable)(int, int*);
    bool      (*is_enabled)(int, int*);
    char      name[DB_NAME_SIZE];
    char      path[PATH_LENGTH];
    char      *dump_file;
    char      *aol_file;
    FILE      *aolfd;
    int       feature_set;
    int       rcrd_cnt;
    int       key_collisions;
    time_t    created;
    size_t    cur_ht_size;
    ol_bucket **hashes;
} ol_database;
</code></pre><p>The object representing a database.</p><h3 id="ol_meta">ol_meta</h3><pre><code>typedef struct ol_meta {
    time_t uptime;
} ol_meta;
</code></pre><p>Structure used to record meta-information about the database.</p></div><div class="doc_chunk"><h2 id="functions">Functions</h2><h3 id="ol_open">ol_open</h3><pre><code>ol_database *ol_open(char *path, char *name);
</code></pre><p>Opens a database for use.</p><p><span class="bold">*path:</span> The directory where the database will be stored.</p><p><span class="bold">*name:</span> The name of the database. This is used to create the dumpfile, and keep track of the database.</p><p><span class="bold">Returns:</span> A new database object.</p><h3 id="ol_close">ol_close</h3><pre><code>int ol_close(ol_database *database);
</code></pre><p>Closes a database cleanly, frees memory and makes sure everything is written.</p><p><span class="bold">*database:</span> The database to close.</p><p><span class="bold">Returns:</span> 0 on success, 1 if not everything could be freed.</p><h3 id="ol_close_save">ol_close_save</h3><pre><code>int ol_close_save(ol_database *database);
</code></pre><p>Dumps and closes a database cleanly, frees memory and makes sure everything is written.</p><p><span class="bold">*database:</span> The database to close.</p><p><span class="bold">Returns:</span> 0 on success, 1 if not everything could be freed.</p><h3 id="ol_unjar">ol_unjar</h3><pre><code>ol_val ol_unjar(ol_database *db, const char *key, size_t klen);
</code></pre><p>Unjar a value from the mayo. Calls ol_unjar_ks with a dsize of null.</p><p><span class="bold">*db:</span> Database to retrieve value from.</p><p><span class="bold">*key:</span> The key to use.</p><p><span class="bold">klen:</span> The length of the key.</p><p><span class="bold">Returns:</span> A pointer to an ol_val object, or NULL if the object was not found.</p><h3 id="ol_unjar_ks">ol_unjar_ks</h3><pre><code>ol_val ol_unjar_ds(ol_database *db, const char *key, size_t klen, size_t *dsize);
</code></pre><p>Unjar a value from the mayo. Makes ksize a reference to the size of the data returned.</p><p><span class="bold">*db:</span> Database to retrieve value from.</p><p><span class="bold">*key:</span> The key to use.</p><p><span class="bold">klen:</span> The length of the key to use.</p><p><span class="bold">*dsize:</span> The key to use.</p><p><span class="bold">Returns:</span> A pointer to an ol_val object, or NULL if the object was not found.</p><h3 id="ol_jar">ol_jar</h3><pre><code>int ol_jar(ol_database *db, const char *key, size_t klen, unsigned char *value, size_t vsize);
</code></pre><p>Put a value into the mayo. It's easy to piss in a bucket, it's not easy to piss in 19 jars. Uses default content type.</p><p><span class="bold">*db:</span> Database to retrieve value from.</p><p><span class="bold">*key:</span> The key to use.</p><p><span class="bold">klen:</span> The length of the key.</p><p><span class="bold">*value:</span> The value to insert.</p><p><span class="bold">vsize:</span> The size of the value in bytes.</p><p><span class="bold">Returns:</span> 0 on sucess.</p><h3 id="ol_jar_ct">ol_jar_ct</h3><pre><code>int ol_jar_ct(ol_database *db, const char *key, size_t klen, unsigned char *value, size_t vsize,
        const char *content_type, const size_t content_type_size);
</code></pre><p>Put a value into the mayo. It's easy to piss in a bucket, it's not easy to piss in 19 jars. Allows you to specify content type.</p><p><span class="bold">*db:</span> Database to retrieve value from.</p><p><span class="bold">*key:</span> The key to use.</p><p><span class="bold">klen:</span> The key to use.</p><p><span class="bold">*value:</span> The value to insert.</p><p><span class="bold">vsize:</span> The size of the value in bytes.</p><p><span class="bold">*content_type:</span> The content type to store, or really anything. Store your middle name if you want to.</p><p><span class="bold">content_type_size:</span> The length of the content_type string.</p><p><span class="bold">Returns:</span> 0 on sucess.</p><h3 id="ol_content_type">ol_content_type</h3><pre><code>char *ol_content_type(ol_database *db, const char *key, size_t klen);
</code></pre><p>Retrieves the content type for a given key from the database.</p><p><span class="bold">*db:</span> Database to retrieve value from.</p><p><span class="bold">*key:</span> The key to use.</p><p><span class="bold">klen:</span> The length of the key.</p><p><span class="bold">Returns:</span> Stored content type, or NULL if it was not found.</p><h3 id="ol_scoop">ol_scoop</h3><pre><code>int ol_scoop(ol_database *db, const char *key, size_t klen);
</code></pre><p>Removes an object from the database. Get that crap out of the mayo jar.</p><p><span class="bold">*db:</span> Database to retrieve value from.</p><p><span class="bold">*key:</span> The key to use.</p><p><span class="bold">klen:</span> The length of the key.</p><p><span class="bold">Returns:</span> 0 on success, 2 if the object wasn't found.</p><h3 id="ol_uptime">ol_uptime</h3><pre><code>int ol_uptime(ol_database *db);
</code></pre><p>Gets the time, in seconds, that a database has been up.</p><p><span class="bold">*db:</span> Database to retrieve value from.</p><p><span class="bold">Returns:</span> Uptime in seconds since database initialization.</p><h3 id="ol_ht_bucket_max">ol_ht_bucket_max</h3><pre><code>int ol_ht_bucket_max(size_t ht_size);
</code></pre><p>Does some sizeof witchery to return the maximum current size of the database.</p><p><span class="bold">*ht_size:</span> The size you want to divide by sizeof(ol_bucket).</p><p><span class="bold">Returns:</span> The maximum possible bucket slots for db.</p></div></div></div></div></div><div id="busted_pixel"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEUA/wA0XsCoAAAACklEQVR4nGNiAAAABgADNjd8qAAAAABJRU5ErkJggg=="></div></body><footer><div class="grid grid-pad"><div class="col-1-2"><div class="content"><ul><li>&copy; Copyright 2014, Quinlan Pfiffer, Kyle Terry</li></ul></div></div><div class="col-1-2"><div class="pull-right content"><ul><li><a href="http://www.redbubble.com/people/qpfiffer/works/11380090-olegdb-graphics">Merch</a></li><li><a href="/credits.html">Credits</a></li><li>Contact: <a href="mailto:shithouse@goatse.cx">shithouse@goatse.cx</a></li></ul></div></div></div></footer><script type="text/javascript">var _gaq = _gaq || [];_gaq.push(['_setAccount', 'UA-30510579-4']);_gaq.push(['_trackPageview']);(function() {var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);})();</script></html>